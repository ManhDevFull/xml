@model XmlRestaurantChain.Web.Models.DashboardViewModel
@{
    ViewData["Title"] = "Bảng điều khiển";
}

<div class="page-header">
    <div>
        <p class="eyebrow">Quản lý chuỗi nhà hàng</p>
        <h1>Bảng điều khiển tổng hợp</h1>
        <p class="muted">Theo dõi đặt bàn, order, kho, nhân sự &amp; loyalty trên một màn hình. Dữ liệu chạy PostgreSQL (xml_db).</p>
    </div>
    <div class="pill-group">
        <span class="pill">Admin</span>
        <span class="pill">Manager</span>
        <span class="pill pill-soft">Staff</span>
    </div>
</div>

@if (TempData["Toast"] is string toast)
{
    <div class="toast toast-success">@toast</div>
}

<section class="metrics-grid">
    <div class="metric-card">
        <p class="muted small">Doanh thu hôm nay</p>
        <h2>@string.Format("{0:N0} đ", Model.Metrics.TodayRevenue)</h2>
    </div>
    <div class="metric-card">
        <p class="muted small">Số đặt bàn</p>
        <h2>@Model.Metrics.Reservations</h2>
    </div>
    <div class="metric-card">
        <p class="muted small">Khách trong ngày</p>
        <h2>@Model.Metrics.Guests</h2>
    </div>
    <div class="metric-card alert-card">
        <p class="muted small">Cảnh báo kho</p>
        <h2>@Model.Metrics.InventoryAlerts</h2>
    </div>
    <div class="metric-card">
        <p class="muted small">Order đang mở</p>
        <h2>@Model.Metrics.OpenOrders</h2>
    </div>
</section>

<section class="grid-2">
    <div class="card-panel">
        <div class="panel-head">
            <div>
                <p class="label">Đặt bàn</p>
                <h3>Tạo đặt bàn nhanh</h3>
            </div>
            <span class="pill">Staff</span>
        </div>
        <form asp-action="CreateReservation" method="post" class="form-grid">
            <input asp-for="Forms.NewReservation.CustomerName" placeholder="Tên khách" required />
            <input asp-for="Forms.NewReservation.CustomerPhone" placeholder="Số điện thoại" required />
            <input asp-for="Forms.NewReservation.PartySize" type="number" min="1" />
            <input asp-for="Forms.NewReservation.ReservedAt" type="datetime-local" />
            <textarea asp-for="Forms.NewReservation.Notes" placeholder="Ghi chú"></textarea>
            <select asp-for="Forms.NewReservation.RestaurantId">
                @foreach (var r in Model.Restaurants)
                {
                    <option value="@r.Id">@r.Name</option>
                }
            </select>
            <select asp-for="Forms.NewReservation.DiningTableId">
                @foreach (var t in Model.Tables)
                {
                    <option value="@t.Id">@t.Name (@t.Capacity chỗ)</option>
                }
            </select>
            <select asp-for="Forms.NewReservation.Status">
                @foreach (var status in Enum.GetValues<XmlRestaurantChain.Web.Models.ReservationStatus>())
                {
                    <option value="@status">@status</option>
                }
            </select>
            <button type="submit" class="btn btn-primary full">Lưu đặt bàn</button>
        </form>
        <div class="list">
            @foreach (var r in Model.UpcomingReservations)
            {
                <div class="list-row">
                    <div>
                        <strong>@r.CustomerName</strong>
                        <p class="muted small">@r.ReservedAt.ToLocalTime():dd/MM HH:mm · @r.DiningTable.Name · @r.Restaurant.Name</p>
                    </div>
                    <span class="pill">@r.Status</span>
                </div>
            }
        </div>
    </div>
    <div class="card-panel">
        <div class="panel-head">
            <div>
                <p class="label">Order &amp; Menu</p>
                <h3>Tạo order</h3>
            </div>
            <span class="pill">Staff</span>
        </div>
        <form asp-action="CreateOrder" method="post" class="form-grid">
            <select asp-for="Forms.NewOrder.RestaurantId">
                @foreach (var r in Model.Restaurants)
                {
                    <option value="@r.Id">@r.Name</option>
                }
            </select>
            <select asp-for="Forms.NewOrder.DiningTableId">
                <option value="">Chọn bàn (optional)</option>
                @foreach (var t in Model.Tables)
                {
                    <option value="@t.Id">@t.Name</option>
                }
            </select>
            <select asp-for="Forms.NewOrder.ReservationId">
                <option value="">Gắn với đặt bàn (optional)</option>
                @foreach (var res in Model.UpcomingReservations)
                {
                    <option value="@res.Id">@res.CustomerName - @res.ReservedAt.ToLocalTime():HH:mm</option>
                }
            </select>
            <select asp-for="Forms.NewOrder.Type">
                @foreach (var type in Enum.GetValues<XmlRestaurantChain.Web.Models.OrderType>())
                {
                    <option value="@type">@type</option>
                }
            </select>
            <select asp-for="Forms.NewOrder.SelectedMenuItemIds" multiple size="6">
                @foreach (var m in Model.MenuItems)
                {
                    <option value="@m.Id">@m.Name (@string.Format("{0:N0} đ", m.Price))</option>
                }
            </select>
            <textarea asp-for="Forms.NewOrder.Notes" placeholder="Ghi chú chế biến..."></textarea>
            <button type="submit" class="btn btn-primary full">Tạo order</button>
        </form>
        <div class="list">
            @foreach (var o in Model.ActiveOrders)
            {
                <div class="list-row">
                    <div>
                        <strong>#@o.Id · @o.Restaurant.Name</strong>
                        <p class="muted small">@o.Type - @o.CreatedAt.ToLocalTime():HH:mm</p>
                        <p class="muted small">Món: @string.Join(", ", o.Items.Select(i => i.MenuItem.Name))</p>
                    </div>
                    <form asp-action="UpdateOrderStatus" method="post" class="inline-form">
                        <input type="hidden" name="id" value="@o.Id" />
                        <select name="status">
                            @foreach (var s in Enum.GetValues<XmlRestaurantChain.Web.Models.OrderStatus>())
                            {
                                <option value="@s" selected="@(s == o.Status ? "selected" : null)">@s</option>
                            }
                        </select>
                        <button class="btn btn-ghost" type="submit">Cập nhật</button>
                    </form>
                </div>
            }
        </div>
    </div>
</section>

<section class="grid-3">
    <div class="card-panel">
        <div class="panel-head">
            <div>
                <p class="label">Nhà hàng &amp; bàn</p>
                <h3>Quản lý cơ sở</h3>
            </div>
            <span class="pill">Manager</span>
        </div>
        <form asp-action="CreateRestaurant" method="post" class="form-grid compact">
            <input asp-for="Forms.NewRestaurant.Name" placeholder="Tên nhà hàng" />
            <input asp-for="Forms.NewRestaurant.City" placeholder="Thành phố" />
            <input asp-for="Forms.NewRestaurant.Country" placeholder="Quốc gia" />
            <input asp-for="Forms.NewRestaurant.Address" placeholder="Địa chỉ" />
            <input asp-for="Forms.NewRestaurant.Phone" placeholder="Điện thoại" />
            <input asp-for="Forms.NewRestaurant.Email" placeholder="Email" />
            <input asp-for="Forms.NewRestaurant.ThemeColor" placeholder="Màu chủ đạo (#hex)" />
            <textarea asp-for="Forms.NewRestaurant.Description" placeholder="Mô tả"></textarea>
            <button class="btn btn-primary full" type="submit">Thêm nhà hàng</button>
        </form>
        <form asp-action="CreateTable" method="post" class="form-inline">
            <select asp-for="Forms.NewTable.RestaurantId">
                @foreach (var r in Model.Restaurants)
                {
                    <option value="@r.Id">@r.Name</option>
                }
            </select>
            <input asp-for="Forms.NewTable.Name" placeholder="Tên bàn" />
            <input asp-for="Forms.NewTable.Capacity" type="number" min="1" placeholder="Số chỗ" />
            <select asp-for="Forms.NewTable.Status">
                @foreach (var s in Enum.GetValues<XmlRestaurantChain.Web.Models.TableStatus>())
                {
                    <option value="@s">@s</option>
                }
            </select>
            <button class="btn btn-ghost" type="submit">Thêm bàn</button>
        </form>
        <div class="list scrollable">
            @foreach (var table in Model.Tables)
            {
                <div class="list-row">
                    <div>
                        <strong>@table.Name</strong>
                        <p class="muted small">@table.Restaurant.Name · @table.Capacity chỗ</p>
                    </div>
                    <form asp-action="UpdateTableStatus" method="post" class="inline-form">
                        <input type="hidden" name="id" value="@table.Id" />
                        <select name="status">
                            @foreach (var s in Enum.GetValues<XmlRestaurantChain.Web.Models.TableStatus>())
                            {
                                <option value="@s" selected="@(s == table.Status ? "selected" : null)">@s</option>
                            }
                        </select>
                        <button class="btn btn-ghost" type="submit">Lưu</button>
                    </form>
                </div>
            }
        </div>
    </div>
    <div class="card-panel">
        <div class="panel-head">
            <div>
                <p class="label">Menu</p>
                <h3>Danh mục &amp; món</h3>
            </div>
            <span class="pill">Manager</span>
        </div>
        <form asp-action="CreateCategory" method="post" class="form-inline">
            <input asp-for="Forms.NewCategory.Name" placeholder="Danh mục" />
            <input asp-for="Forms.NewCategory.Description" placeholder="Mô tả" />
            <select asp-for="Forms.NewCategory.RestaurantId">
                @foreach (var r in Model.Restaurants)
                {
                    <option value="@r.Id">@r.Name</option>
                }
            </select>
            <button class="btn btn-ghost" type="submit">Thêm</button>
        </form>
        <form asp-action="CreateMenuItem" method="post" class="form-grid compact">
            <input asp-for="Forms.NewMenuItem.Name" placeholder="Tên món" />
            <input asp-for="Forms.NewMenuItem.Price" type="number" step="1000" placeholder="Giá" />
            <textarea asp-for="Forms.NewMenuItem.Description" placeholder="Mô tả / nguyên liệu"></textarea>
            <select asp-for="Forms.NewMenuItem.MenuCategoryId">
                @foreach (var c in Model.Categories)
                {
                    <option value="@c.Id">@c.Name (@c.Restaurant.Name)</option>
                }
            </select>
            <select asp-for="Forms.NewMenuItem.IsAvailable">
                <option value="true">Đang bán</option>
                <option value="false">Tạm dừng</option>
            </select>
            <button class="btn btn-primary full" type="submit">Thêm món</button>
        </form>
        <div class="list scrollable">
            @foreach (var item in Model.MenuItems)
            {
                <div class="list-row">
                    <div>
                        <strong>@item.Name</strong>
                        <p class="muted small">@item.MenuCategory?.Name · @string.Format("{0:N0} đ", item.Price)</p>
                    </div>
                    <span class="pill @(item.IsAvailable ? "" : "pill-soft")">@((item.IsAvailable) ? "Bán" : "Dừng")</span>
                </div>
            }
        </div>
    </div>
    <div class="card-panel">
        <div class="panel-head">
            <div>
                <p class="label">Kho &amp; NCC</p>
                <h3>Quản lý tồn kho</h3>
            </div>
            <span class="pill">Manager</span>
        </div>
        <form asp-action="CreateSupplier" method="post" class="form-grid compact">
            <input asp-for="Forms.NewSupplier.Name" placeholder="Nhà cung cấp" />
            <input asp-for="Forms.NewSupplier.ContactPhone" placeholder="Điện thoại" />
            <input asp-for="Forms.NewSupplier.ContactEmail" placeholder="Email" />
            <input asp-for="Forms.NewSupplier.Address" placeholder="Địa chỉ" />
            <button class="btn btn-ghost full" type="submit">Thêm NCC</button>
        </form>
        <form asp-action="CreateInventoryItem" method="post" class="form-grid compact">
            <input asp-for="Forms.NewInventoryItem.Name" placeholder="Nguyên liệu" />
            <input asp-for="Forms.NewInventoryItem.Unit" placeholder="Đơn vị" />
            <input asp-for="Forms.NewInventoryItem.Quantity" type="number" step="0.1" placeholder="Số lượng" />
            <input asp-for="Forms.NewInventoryItem.ReorderLevel" type="number" step="0.1" placeholder="Mức cảnh báo" />
            <select asp-for="Forms.NewInventoryItem.RestaurantId">
                @foreach (var r in Model.Restaurants)
                {
                    <option value="@r.Id">@r.Name</option>
                }
            </select>
            <select asp-for="Forms.NewInventoryItem.SupplierId">
                <option value="">Chọn NCC</option>
                @foreach (var s in Model.Suppliers)
                {
                    <option value="@s.Id">@s.Name</option>
                }
            </select>
            <textarea asp-for="Forms.NewInventoryItem.Notes" placeholder="Ghi chú kho..."></textarea>
            <button class="btn btn-primary full" type="submit">Thêm tồn kho</button>
        </form>
        <div class="list scrollable">
            @foreach (var i in Model.LowInventory)
            {
                <div class="list-row">
                    <div>
                        <strong>@i.Name</strong>
                        <p class="muted small">@i.Restaurant.Name · @i.Quantity @i.Unit (cảnh báo: @i.ReorderLevel)</p>
                        <p class="muted small">NCC: @i.Supplier?.Name</p>
                    </div>
                    <span class="pill alert">@((i.Quantity <= i.ReorderLevel) ? "Cần nhập" : "Thấp")</span>
                </div>
            }
        </div>
    </div>
</section>

<section class="grid-2">
    <div class="card-panel">
        <div class="panel-head">
            <div>
                <p class="label">Nhân sự</p>
                <h3>Staff &amp; roles</h3>
            </div>
            <span class="pill">Admin</span>
        </div>
        <div class="list scrollable">
            @foreach (var s in Model.Staff)
            {
                <div class="list-row">
                    <div>
                        <strong>@s.User.DisplayName</strong>
                        <p class="muted small">@s.Position · @s.Restaurant.Name</p>
                        <p class="muted small">@s.User.Email</p>
                    </div>
                    <span class="pill pill-soft">@s.HiredDate.ToLocalTime():dd/MM/yyyy</span>
                </div>
            }
        </div>
        <p class="muted small">Tạo thêm user tại menu Identity /Account/Register, sau đó gán role trong DB hoặc seeding.</p>
    </div>
    <div class="card-panel">
        <div class="panel-head">
            <div>
                <p class="label">Loyalty</p>
                <h3>Khách hàng thân thiết</h3>
            </div>
            <span class="pill">Staff</span>
        </div>
        <form asp-action="CreateLoyaltyMember" method="post" class="form-grid compact">
            <input asp-for="Forms.NewLoyaltyMember.CustomerName" placeholder="Tên khách" />
            <input asp-for="Forms.NewLoyaltyMember.Phone" placeholder="SĐT" />
            <input asp-for="Forms.NewLoyaltyMember.Email" placeholder="Email" />
            <input asp-for="Forms.NewLoyaltyMember.Points" type="number" placeholder="Điểm" />
            <input asp-for="Forms.NewLoyaltyMember.Tier" placeholder="Hạng" />
            <select asp-for="Forms.NewLoyaltyMember.RestaurantId">
                @foreach (var r in Model.Restaurants)
                {
                    <option value="@r.Id">@r.Name</option>
                }
            </select>
            <button class="btn btn-primary full" type="submit">Lưu khách</button>
        </form>
        <div class="list scrollable">
            @foreach (var l in Model.LoyaltyMembers)
            {
                <div class="list-row">
                    <div>
                        <strong>@l.CustomerName</strong>
                        <p class="muted small">@l.Phone · @l.Restaurant.Name</p>
                    </div>
                    <span class="pill">@l.Tier (@l.Points) </span>
                </div>
            }
        </div>
    </div>
</section>
